name: Build Mobile Apps (APK & IPA)

on:
  push:
    branches: [main]
  workflow_dispatch: # Memungkinkan Anda menjalankan build manual dari UI GitHub

jobs:
  # build-android:
  #   name: Build Android APK
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 22

  #     - name: Install Dependencies
  #       run: npm install

  #     - name: Build Web Project
  #       run: npm run build

  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'zulu'
  #         java-version: '17'

  #     - name: Build Android APK
  #       run: |
  #         npx cap sync android
  #         cd android
  #         ./gradlew assembleDebug

  #     - name: Upload APK
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: app-debug-apk
  #         path: android/app/build/outputs/apk/debug/app-debug.apk

  build-ios:
    name: Build iOS IPA
    runs-on: macos-15 # Menggunakan macOS terbaru untuk Xcode 16+
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install

      - name: Build Web Project
        run: npm run build

      - name: Sync Capacitor iOS
        run: |
          # Memastikan folder ios ada dan sinkron
          npx cap sync ios

      - name: Build iOS Archive
        run: |
          # Menggunakan path standar Capacitor v7
          xcodebuild -workspace ios/App/App.xcworkspace \
                     -scheme App \
                     -configuration Debug \
                     -sdk iphoneos \
                     -destination 'generic/platform=iOS' \
                     -archivePath ios/App.xcarchive \
                     archive \
                     CODE_SIGNING_ALLOWED=NO

      - name: Export Payload for IPA
        run: |
          # Mengemas .app menjadi file .ipa mentah (unsigned)
          mkdir -p Payload
          cp -r ios/App.xcarchive/Products/Applications/App.app Payload/
          zip -r App.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-ipa
          path: App.ipa
