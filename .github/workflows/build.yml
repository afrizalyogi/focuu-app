name: Build Mobile Apps (APK & IPA)

on:
  push:
    branches: [main]
  workflow_dispatch: # Memungkinkan Anda menjalankan build manual dari UI GitHub

jobs:
  # build-android:
  #   name: Build Android APK
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 22

  #     - name: Install Dependencies
  #       run: npm install

  #     - name: Build Web Project
  #       run: npm run build

  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'zulu'
  #         java-version: '17'

  #     - name: Build Android APK
  #       run: |
  #         npx cap sync android
  #         cd android
  #         ./gradlew assembleDebug

  #     - name: Upload APK
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: app-debug-apk
  #         path: android/app/build/outputs/apk/debug/app-debug.apk

  build-ios:
    name: Build iOS IPA
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install

      - name: Build Web Project
        run: npm run build

      - name: Prepare Capacitor iOS
        run: |
          # Jika folder ios sama sekali tidak ada, tambahkan platformnya
          if [ ! -d "ios" ]; then
            echo "Folder ios tidak ditemukan, menjalankan cap add ios..."
            npx cap add ios
          fi
          npx cap sync ios

      - name: Find Workspace Path
        id: find_step
        run: |
          # Mencari file .xcworkspace secara mendalam
          WS_PATH=$(find ios -name "*.xcworkspace" | head -n 1)
          if [ -z "$WS_PATH" ]; then
            echo "CRITICAL ERROR: xcworkspace tidak ditemukan di folder ios!"
            ls -R ios
            exit 1
          fi
          echo "ws_path=$WS_PATH" >> $GITHUB_OUTPUT
          echo "Found Workspace: $WS_PATH"

      - name: Build iOS Archive
        run: |
          xcodebuild -workspace "${{ steps.find_step.outputs.ws_path }}" \
                     -scheme App \
                     -configuration Debug \
                     -sdk iphoneos \
                     -destination 'generic/platform=iOS' \
                     -archivePath ios/App.xcarchive \
                     archive \
                     CODE_SIGNING_ALLOWED=NO

      - name: Export Payload for IPA
        run: |
          APP_PATH=$(find ios/App.xcarchive -name "*.app" | head -n 1)
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r App.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-ipa
          path: App.ipa
